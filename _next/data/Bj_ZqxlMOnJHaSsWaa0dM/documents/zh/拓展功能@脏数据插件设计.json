{"pageProps":{"content":"\n              <a id=\"背景\" style='display: block; height: 35px;'></a>\n              <h2>\n                背景\n              </h2>\n            <p>目前任务对脏数据的处理仅仅是日志打印，这样显然是无法应对客户多变的使用场景。</p>\n\n              <a id=\"方案\" style='display: block; height: 35px;'></a>\n              <h2>\n                方案\n              </h2>\n            <p>整体架构采用生产者-消费者模式，任务启动过程中，同时将 Manager 初始化并启动 Consumer 异步线程池，仅需在 BaseRichInputFormat 和 BaseRichOutputFormat 调用 Manager 的 collect() 方法收集脏数据即可。\n流程图\n<img src=\"/chunjun/doc/dirty/dirty-1.png\" alt=\"image\"></p>\n<p><img src=\"/chunjun/doc/dirty/dirty-2.png\" alt=\"image\"></p>\n\n              <a id=\"详细描述\" style='display: block; height: 35px;'></a>\n              <h2>\n                详细描述\n              </h2>\n            <p>任务配置参数\n对应 Java 实体类 - DirtyConf\n<img src=\"/chunjun/doc/dirty/dirty-conf.png\" alt=\"image\"></p>\n<ul>\n<li>type\n插件类型，必填项，根据 type 动态加载对应的插件；</li>\n<li>printRate\n脏数据在日志中的打印频率，默认值修改为 1，表示默认脏数据信息都会打印到日志文件中，同时，如果 printRate &lt;= 0，表示不打印任何脏数据信息；</li>\n<li>errorLimit\n脏数据在插件中，处理失败的条数限制，当处理失败的脏数据条数超过这个限制时，任务抛出 NoRestartException，即任务失败且不重试；默认值修改为 1，如果 errorLimit &lt; 0，表示任务容忍所有的异常，不失败；</li>\n<li>totalLimit\n脏数据总条数限制，即收集到的脏数据超过这个限制时，任务抛出 NoRestartException，即任务失败且不重试；默认值修改为 1，如果 totalLimit &lt; 0，表示任务容忍所有的异常，不失败；</li>\n<li>properties\n各自插件的参数配置</li>\n</ul>\n<p>脏数据插件管理者\n对应 Java 实体类 - DirtyManager\n<img src=\"/chunjun/doc/dirty/dirty-manager.png\" alt=\"image\">\n<img src=\"/chunjun/doc/dirty/dirty-manager.png\" alt=\"image\"></p>\n<p>Manager 主要维护着脏数据消费者 Consumer 和 一个异步线程池；</p>\n<ul>\n<li><p>主要作用是收集脏数据，并下发到 Consumer 队列中</p>\n</li>\n<li><p>调用 collect() 方法\nBaseRichInputFormat</p>\n</li>\n</ul>\n<p>脏数据插件消费者\n对应 Java 实体类 - AbstractDirtyConsumer\nConsumer 主要维护着一个消息队列，中间缓存着脏数据信息；</p>\n<ul>\n<li><p>run() 方法\n主要逻辑是消费队列中的脏数据，consume() 方法交给子类去实现；如果在 consume 过程中出现了异常，那么 errorCounter 计数加一。</p>\n</li>\n<li><p>consume() 方法\n处理脏数据的具体逻辑，交由子类实现，根据插件的不同，对脏数据处理逻辑也会有所不同。</p>\n</li>\n</ul>\n\n              <a id=\"以下参数在 ChunJun 启动参数-confProp 中\" style='display: block; height: 35px;'></a>\n              <h2>\n                以下参数在 ChunJun 启动参数-confProp 中\n              </h2>\n            <pre><code class=\"language-yaml\">chunjun<span class=\"hljs-selector-class\">.dirty-data</span><span class=\"hljs-selector-class\">.output-type</span> = log/jdbc\nchunjun<span class=\"hljs-selector-class\">.dirty-data</span><span class=\"hljs-selector-class\">.max-rows</span> = <span class=\"hljs-number\">1000</span> <span class=\"hljs-comment\">// total limit</span>\nchunjun<span class=\"hljs-selector-class\">.dirty-data</span><span class=\"hljs-selector-class\">.max-collect-failed-rows</span> = <span class=\"hljs-number\">1000</span> <span class=\"hljs-comment\">// error limit</span>\n\nchunjun<span class=\"hljs-selector-class\">.dirty-data</span><span class=\"hljs-selector-class\">.jdbc</span>.url=\nchunjun<span class=\"hljs-selector-class\">.dirty-data</span><span class=\"hljs-selector-class\">.jdbc</span>.username=\nchunjun<span class=\"hljs-selector-class\">.dirty-data</span><span class=\"hljs-selector-class\">.jdbc</span>.password=\nchunjun<span class=\"hljs-selector-class\">.dirty-data</span><span class=\"hljs-selector-class\">.jdbc</span>.database=   <span class=\"hljs-comment\">// database 可以写在 url</span>\nchunjun<span class=\"hljs-selector-class\">.dirty-data</span><span class=\"hljs-selector-class\">.jdbc</span>.table=\n\nchunjun<span class=\"hljs-selector-class\">.dirty-data</span><span class=\"hljs-selector-class\">.log</span>.print-interval= <span class=\"hljs-number\">500</span>\n</code></pre>\n<p>JDBC 建表语句（MySQL）</p>\n<pre><code class=\"language-sql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">EXISTS</span> chunjun_dirty_data\n(\njob_id        <span class=\"hljs-type\">VARCHAR</span>(<span class=\"hljs-number\">32</span>)                               <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">&#x27;Flink Job Id&#x27;</span>,\njob_name      <span class=\"hljs-type\">VARCHAR</span>(<span class=\"hljs-number\">255</span>)                              <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">&#x27;Flink Job Name&#x27;</span>,\noperator_name <span class=\"hljs-type\">VARCHAR</span>(<span class=\"hljs-number\">255</span>)                              <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">&#x27;出现异常数据的算子名，包含表名&#x27;</span>,\ndirty_data    <span class=\"hljs-type\">TEXT</span>                                      <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">&#x27;脏数据的异常数据&#x27;</span>,\nerror_message <span class=\"hljs-type\">TEXT</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">&#x27;脏数据中异常原因&#x27;</span>,\nfield_name    <span class=\"hljs-type\">VARCHAR</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">&#x27;脏数据中异常字段名&#x27;</span>,\ncreate_time    <span class=\"hljs-type\">TIMESTAMP</span>(<span class=\"hljs-number\">6</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-built_in\">CURRENT_TIMESTAMP</span>(<span class=\"hljs-number\">6</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span> <span class=\"hljs-keyword\">ON</span> <span class=\"hljs-keyword\">UPDATE</span> <span class=\"hljs-built_in\">CURRENT_TIMESTAMP</span>(<span class=\"hljs-number\">6</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">&#x27;脏数据出现的时间点&#x27;</span>\n)\n<span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">&#x27;存储脏数据&#x27;</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> idx_job_id <span class=\"hljs-keyword\">ON</span> chunjun_dirty_data (job_id);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> idx_operator_name <span class=\"hljs-keyword\">ON</span> chunjun_dirty_data(operator_name);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> idx_create_time <span class=\"hljs-keyword\">ON</span> chunjun_dirty_data(create_time);\nMetircs\nchunjun_DirtyData_count\nchunjun_DirtyData_collectFailedCount\n</code></pre>\n\n              <a id=\"项目目录结构\" style='display: block; height: 35px;'></a>\n              <h2>\n                项目目录结构\n              </h2>\n            \n              <a id=\"父模块\" style='display: block; height: 35px;'></a>\n              <h3>\n                父模块\n              </h3>\n            <p>chunjun-dirty</p>\n\n              <a id=\"子模块\" style='display: block; height: 35px;'></a>\n              <h3>\n                子模块\n              </h3>\n            <p>chunjun-dirty-mysql\nchunjun-dirty-log</p>\n","tree":[{"label":"ChunJun通用配置详解","category":"file"},{"label":"快速开始","category":"file"},{"label":"ChunJun拓展数据格式","children":[{"label":"protobuf-x","path":"protobuf-x","category":"file"}],"category":"dir"},{"label":"ChunJun连接器","children":[{"label":"binlog","category":"dir","children":[{"label":"binlog-source","path":"binlog-source","category":"file"}]},{"label":"clickhouse","category":"dir","children":[{"label":"clickhouse-lookup","path":"clickhouse-lookup","category":"file"},{"label":"clickhouse-sink","path":"clickhouse-sink","category":"file"},{"label":"clickhouse-source","path":"clickhouse-source","category":"file"}]},{"label":"db2","category":"dir","children":[{"label":"db2-lookup","path":"db2-lookup","category":"file"},{"label":"db2-sink","path":"db2-sink","category":"file"},{"label":"db2-source","path":"db2-source","category":"file"}]},{"label":"dm","category":"dir","children":[{"label":"dm-sink","path":"dm-sink","category":"file"},{"label":"dm-source","path":"dm-source","category":"file"}]},{"label":"doris","category":"dir","children":[{"label":"dorisbatch-sink","path":"dorisbatch-sink","category":"file"}]},{"label":"elasticsearch","category":"dir","children":[{"label":"es7-lookup","path":"es7-lookup","category":"file"},{"label":"es7-sink","path":"es7-sink","category":"file"},{"label":"es7-source","path":"es7-source","category":"file"}]},{"label":"gbase","category":"dir","children":[{"label":"gbase-lookup","path":"gbase-lookup","category":"file"},{"label":"gbase-sink","path":"gbase-sink","category":"file"},{"label":"gbase-source","path":"gbase-source","category":"file"}]},{"label":"greenplum","category":"dir","children":[{"label":"greenplum-sink","path":"greenplum-sink","category":"file"},{"label":"greenplum-source","path":"greenplum-source","category":"file"}]},{"label":"hbase","category":"dir","children":[{"label":"hbase-lookup","path":"hbase-lookup","category":"file"},{"label":"hbase-sink","path":"hbase-sink","category":"file"},{"label":"hbase-source","path":"hbase-source","category":"file"}]},{"label":"hdfs","category":"dir","children":[{"label":"hdfs-sink","path":"hdfs-sink","category":"file"},{"label":"hdfs-source","path":"hdfs-source","category":"file"}]},{"label":"hive","category":"dir","children":[{"label":"hive-lookup","path":"hive-lookup","category":"file"},{"label":"hive-sink","path":"hive-sink","category":"file"}]},{"label":"influxdb","category":"dir","children":[{"label":"influxdb-sink","path":"influxdb-sink","category":"file"},{"label":"influxdb-source","path":"influxdb-source","category":"file"}]},{"label":"kafka","category":"dir","children":[{"label":"kafka-sink","path":"kafka-sink","category":"file"},{"label":"kafka-source","path":"kafka-source","category":"file"}]},{"label":"kingbase","category":"dir","children":[{"label":"kingbase-sink","path":"kingbase-sink","category":"file"},{"label":"kingbase-source","path":"kingbase-source","category":"file"}]},{"label":"kudu","category":"dir","children":[{"label":"kudu-lookup","path":"kudu-lookup","category":"file"},{"label":"kudu-sink","path":"kudu-sink","category":"file"},{"label":"kudu-source","path":"kudu-source","category":"file"}]},{"label":"logminer","category":"dir","children":[{"label":"LogMiner-source","path":"LogMiner-source","category":"file"},{"label":"LogMiner原理","path":"LogMiner原理","category":"file"},{"label":"LogMiner配置","path":"LogMiner配置","category":"file"}]},{"label":"mongodb","category":"dir","children":[{"label":"mongodb-lookup","path":"mongodb-lookup","category":"file"},{"label":"mongodb-sink","path":"mongodb-sink","category":"file"},{"label":"mongodb-source","path":"mongodb-source","category":"file"}]},{"label":"mysql","category":"dir","children":[{"label":"mysql-lookup","path":"mysql-lookup","category":"file"},{"label":"mysql-sink","path":"mysql-sink","category":"file"},{"label":"mysql-source","path":"mysql-source","category":"file"}]},{"label":"oracle","category":"dir","children":[{"label":"oracle-lookup","path":"oracle-lookup","category":"file"},{"label":"oracle-sink","path":"oracle-sink","category":"file"},{"label":"oracle-source","path":"oracle-source","category":"file"}]},{"label":"pgwal","category":"dir","children":[{"label":"Postgres-CDC","path":"Postgres-CDC","category":"file"}]},{"label":"postgresql","category":"dir","children":[{"label":"postgres-lookup","path":"postgres-lookup","category":"file"},{"label":"postgres-sink","path":"postgres-sink","category":"file"},{"label":"postgres-source","path":"postgres-source","category":"file"}]},{"label":"rocketmq","category":"dir","children":[{"label":"rocketmq-source","path":"rocketmq-source","category":"file"}]},{"label":"saphana","category":"dir","children":[{"label":"saphana-sink","path":"saphana-sink","category":"file"},{"label":"saphana-source","path":"saphana-source","category":"file"}]},{"label":"sqlserver","category":"dir","children":[{"label":"sqlserver-lookup","path":"sqlserver-lookup","category":"file"},{"label":"sqlserver-sink","path":"sqlserver-sink","category":"file"},{"label":"sqlserver-source","path":"sqlserver-source","category":"file"}]},{"label":"sqlservercdc","category":"dir","children":[{"label":"SqlServer CDC实时采集原理","path":"SqlServer CDC实时采集原理","category":"file"},{"label":"SqlServer配置CDC","path":"SqlServer配置CDC","category":"file"},{"label":"SqlserverCDC-source","path":"SqlserverCDC-source","category":"file"}]}],"category":"dir"},{"label":"开发者指南","children":[{"label":"如何提交一个优秀的PR","path":"如何提交一个优秀的PR","category":"file"},{"label":"如何自定义插件","path":"如何自定义插件","category":"file"}],"category":"dir"},{"label":"拓展功能","children":[{"label":"增量同步介绍","path":"增量同步介绍","category":"file"},{"label":"断点续传介绍","path":"断点续传介绍","category":"file"},{"label":"脏数据插件设计","path":"脏数据插件设计","category":"file"}],"category":"dir"}],"toc":[{"text":"背景","level":2,"id":"00980285-0021-4812-9ef7-7a4b25c539fe"},{"text":"方案","level":2,"id":"14d1d8bb-afe3-4978-a62d-6a9caeb25dad"},{"text":"详细描述","level":2,"id":"6d20001a-fad9-48f2-92cc-044f37991d98"},{"text":"以下参数在 ChunJun 启动参数-confProp 中","level":2,"id":"fc430b5e-6b4b-4eb7-8645-2628b96a2937"},{"text":"项目目录结构","level":2,"id":"66182ded-5060-4e2c-8b93-40de4f2656ed"},{"text":"父模块","level":3,"id":"771bc341-d3e6-448c-8a7a-fc91322c5a3e"},{"text":"子模块","level":3,"id":"fec0a0e2-d2d6-4c42-8cd4-c1e305f4931d"}]},"__N_SSG":true}